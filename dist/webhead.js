function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=e(require("cheerio")),r=e(require("fs-extra")),o=e(require("mime-types")),n=e(require("node-libcurl")),s=e(require("jquery-param"));function i(){return(i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e}).apply(this,arguments)}var a=e(require("tough-cookie")).CookieJar,u=n.curly;module.exports=function(e){var n,c,l,p=e||{},d=p.jarFile,f=p.userAgent,h=p.verbose,m=p.beforeSend,v=p.complete,y={},j={},g=function e(t,r,o){try{var n={method:t.toUpperCase(),url:C(r),options:S(o)};return m&&((n=m(n,j)).method=n.method.toUpperCase(),n.url=C(n.url),n.options=S(n.options)),Promise.resolve(k(n)).then(function(t){var r=t.response,o=t.redirect;return o?e(o.method,o.url,o.options):(y.url=n.url,y.cookie=E(y.url.href),y.response=r,v&&v(n,j,y),r)})}catch(e){return Promise.reject(e)}},C=function(e){return e.constructor==URL&&(e=e.href),y.url&&e.match(/^\//)&&(e=y.url.origin+e),new URL(e)},S=function(e){return e||(e={}),e.headers=b(e.headers),e},b=function(e){return e?Object.entries(e).reduce(function(e,t){var r=t[1];return e[t[0].replace(/\b./g,function(e){return e.toUpperCase()})]=r,e},{}):{}},k=function(e){var t=e.method,r=e.url,n=e.options;try{var i=n.headers,a=n.data,c=n.multiPartData,l=n.json;i.Host=r.host;var p=E(r=r.href),d={};return p.length&&(i.Cookie=p),!i["User-Agent"]&&f&&(i["User-Agent"]=f),a&&(i["Content-Type"]||(i["Content-Type"]="application/x-www-form-urlencoded"),a=s(a),"GET"==t?r+=(r.match(/\?/)?"&":"?")+a:(d.post=!0,d.postFields=a)),c&&(d.httpPost=c.map(function(e){if(e.value&&(e.contents=e.value,delete e.value),e.file&&!e.type){var t=o.lookup(e.file);t&&(e.type=t)}return e})),l&&(i["Content-Type"]="application/json",d.post=!0,d.postFields=JSON.stringify(l)),d.nobody="HEAD"==t,t.match(/(GET|HEAD|POST)/)||(d.customRequest=t),d.httpHeader=Object.entries(i).map(function(e){return e.join(": ")}),h&&console.log(t,r,n),Promise.resolve(u(r,d)).then(function(e){return O(t,r,n,e)})}catch(e){return Promise.reject(e)}},O=function(e,t,o,s){var i,a=s.statusCode,u=s.data,p=s.headers;if(p=b(p[0]),h&&console.log({statusCode:a,data:u,headers:p}),p["Set-Cookie"]){var f=P(t);if(p["Set-Cookie"].forEach(function(e){n.setCookieSync(e,f)}),d){var m=n.toJSON().cookies,v={};r.pathExistsSync(d)&&(v=r.readJsonSync(d)),v.constructor==Object?v.cookies=m:v=m,r.writeFileSync(d,JSON.stringify(v,null,2))}}return/^3/.test(""+a)&&(i={method:e,url:p.Location,options:o},a<=303&&(i.method="GET",delete i.options.data)),c=void 0,l=void 0,{response:{statusCode:a,data:u,headers:p},redirect:i}},P=function(e){return e.replace(/\?.*/,"")},E=function(e){return n.getCookiesSync(P(e)).join("; ")};if("get post put patch delete head options".split(" ").forEach(function(e){y[e]=function(){try{var t=arguments;return Promise.resolve(g.apply(void 0,[e].concat([].slice.call(t))))}catch(e){return Promise.reject(e)}}}),y.text=function(){return y.response?y.response.data:""},y.json=function(){if(!l&&y.response){var e=y.response,t=e.data;t&&(""+e.headers["Content-Type"]).match("json")&&(l=JSON.parse(t))}return l},y.$=function(){if(!c&&y.response){var e=y.response,r=e.data,o=e.headers,n=(""+o["Content-Type"]).match(/(html|xml)/);n&&(c=t.load(r,{xmlMode:"xml"==n[1]}))}return c?c.apply(void 0,[].slice.call(arguments)):[]},y.submit=function(e,t,r){try{var o=y.$(e);return Promise.resolve(function(){if(o.length){var e=o.attr("action"),n=o.attr("method")||"GET";return t=Object.assign(o.serializeArray().reduce(function(e,t){return e[t.name]=t.value,e},{}),t||{}),Promise.resolve(g(n,e,i({},r,{data:t})))}}())}catch(e){return Promise.reject(e)}},r.pathExistsSync(d)){var T=r.readJsonSync(d),x=T.cookies||T;n=a.fromJSON({cookies:x.constructor==Array?x:[]})}else n=new a;return y};
//# sourceMappingURL=webhead.js.map
