function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var t=e(require("cheerio")),r=e(require("fs-extra")),o=e(require("mime-types")),n=e(require("node-libcurl")),a=e(require("jquery-param"));function i(){return(i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var o in r)Object.prototype.hasOwnProperty.call(r,o)&&(e[o]=r[o])}return e}).apply(this,arguments)}var s=e(require("tough-cookie")).CookieJar,u=n.curly;module.exports=function(e){var n,c=e||{},l=c.jarFile,p=c.userAgent,d=c.verbose,f=c.beforeSend,h=c.complete,m={},v={},y=function e(t,r,o){try{var n={method:t.toUpperCase(),url:g(r),options:C(o)};return f&&((n=f(n,v)).method=n.method.toUpperCase(),n.url=g(n.url),n.options=C(n.options)),Promise.resolve(S(n)).then(function(t){var r=t.response,o=t.redirect;return o?e(o.method,o.url,o.options):(m.url=n.url,m.cookie=k(m.url.href),m.$=O(r),m.response=r,h&&h(n,v,m),r)})}catch(e){return Promise.reject(e)}},g=function(e){return e.constructor==URL&&(e=e.href),m.url&&e.match(/^\//)&&(e=m.url.origin+e),new URL(e)},C=function(e){return e||(e={}),e.headers=j(e.headers),e},j=function(e){return e?Object.entries(e).reduce(function(e,t){var r=t[1];return e[t[0].replace(/\b./g,function(e){return e.toUpperCase()})]=r,e},{}):{}},S=function(e){var t=e.method,r=e.url,n=e.options;try{var i=n.headers,s=n.data,c=n.multiPartData;i.Host=r.host;var l=k(r=r.href),f={};return l.length&&(i.Cookie=l),!i["User-Agent"]&&p&&(i["User-Agent"]=p),s&&(i["Content-Type"]||(i["Content-Type"]="application/x-www-form-urlencoded"),s=a(s),"GET"==t?r+=(r.match(/\?/)?"&":"?")+s:(f.post=!0,f.postFields=s)),c&&(f.httpPost=c.map(function(e){if(e.value&&(e.contents=e.value,delete e.value),e.file&&!e.type){var t=o.lookup(e.file);t&&(e.type=t)}return e})),f.nobody="HEAD"==t,t.match(/(GET|HEAD|POST)/)||(f.customRequest=t),f.httpHeader=Object.entries(i).map(function(e){return e.join(": ")}),d&&console.log(t,r,n),Promise.resolve(u(r,f)).then(function(e){return P(t,r,n,e)})}catch(e){return Promise.reject(e)}},P=function(e,t,o,a){var i,s=a.statusCode,u=a.data,c=a.headers;if(c=j(c[0]),d&&console.log({statusCode:s,data:u,headers:c}),c["Set-Cookie"]){var p=b(t);if(c["Set-Cookie"].forEach(function(e){n.setCookieSync(e,p)}),l){var f=n.toJSON().cookies;r.writeFileSync(l,JSON.stringify(f,null,2))}}return/^3/.test(""+s)&&(i={method:e,url:c.Location,options:o},s<=303&&(i.method="GET",delete i.options.data)),{response:{statusCode:s,data:u,headers:c},redirect:i}},b=function(e){return e.replace(/\?.*/,"")},k=function(e){return n.getCookiesSync(b(e)).join("; ")},O=function(e){var r=e.headers,o=e.data;if(/^2/.test(""+e.statusCode)){var n=""+r["Content-Type"];if(n.match("html"))return t.load(o);if(n.match("xml"))return t.load(o,{xmlMode:!0})}};return"get post put patch delete head options".split(" ").forEach(function(e){m[e]=function(){try{var t=arguments;return Promise.resolve(y.apply(void 0,[e].concat([].slice.call(t))))}catch(e){return Promise.reject(e)}}}),m.submit=function(e,t,r){try{var o=m.$(e);return Promise.resolve(function(){if(o.length){var e=o.attr("action"),n=o.attr("method")||"GET";return t=Object.assign(o.serializeArray().reduce(function(e,t){return e[t.name]=t.value,e},{}),t||{}),Promise.resolve(y(n,e,i({},r,{data:t})))}}())}catch(e){return Promise.reject(e)}},m.text=function(){if(m.response)return m.response.data},m.json=function(){if(m.response.data&&m.response.headers["Content-Type"].toString().match("json"))return JSON.parse(m.response.data)},n=r.pathExistsSync(l)?s.fromJSON({cookies:r.readJsonSync(l)}):new s,m};
//# sourceMappingURL=webhead.js.map
