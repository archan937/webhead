function e(e){return e&&"object"==typeof e&&"default"in e?e.default:e}var r=e(require("cheerio")),t=e(require("fs-extra")),o=e(require("node-libcurl")),n=e(require("jquery-param"));function a(){return(a=Object.assign||function(e){for(var r=1;r<arguments.length;r++){var t=arguments[r];for(var o in t)Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o])}return e}).apply(this,arguments)}var i=e(require("tough-cookie")).CookieJar,s=o.curly;module.exports=function(e){var o,u=e||{},c=u.jarFile,l=u.userAgent,d=u.verbose,p=u.beforeSend,f=u.complete,h={},m={},v=function e(r,t,o){try{var n={method:r.toUpperCase(),url:y(t),options:g(o)};return p&&((n=p(n,m)).method=n.method.toUpperCase(),n.url=y(n.url),n.options=g(n.options)),Promise.resolve(j(n)).then(function(r){var t=r.response,o=r.redirect;return o?e(o.method,o.url,o.options):(h.url=n.url,h.cookie=O(h.url.href),h.$=P(t),h.response=t,f&&f(n,m,h),t)})}catch(e){return Promise.reject(e)}},y=function(e){return e.constructor==URL&&(e=e.href),h.url&&e.match(/^\//)&&(e=h.url.origin+e),new URL(e)},g=function(e){return e||(e={}),e.headers=C(e.headers),e},C=function(e){return e?Object.entries(e).reduce(function(e,r){var t=r[1];return e[r[0].replace(/\b./g,function(e){return e.toUpperCase()})]=t,e},{}):{}},j=function(e){var r=e.method,t=e.url,o=e.options;try{var a=o.headers,i=o.data;a.Host=t.host;var u=O(t=t.href),c={};return u.length&&(a.Cookie=u),!a["User-Agent"]&&l&&(a["User-Agent"]=l),i&&(a["Content-Type"]||(a["Content-Type"]="application/x-www-form-urlencoded"),i=n(i),"GET"==r?t+=(t.match(/\?/)?"&":"?")+i:c.postFields=i),c.post="POST"==r,c.nobody="HEAD"==r,r.match(/(GET|HEAD|POST)/)||(c.customRequest=r),c.httpHeader=Object.entries(a).map(function(e){return e.join(": ")}),d&&console.log(r,t,o),Promise.resolve(s(t,c)).then(function(e){return S(r,t,o,e)})}catch(e){return Promise.reject(e)}},S=function(e,r,n,a){var i,s=a.statusCode,u=a.data,l=a.headers;if(l=C(l[0]),d&&console.log({statusCode:s,data:u,headers:l}),l["Set-Cookie"]){var p=b(r);if(l["Set-Cookie"].forEach(function(e){o.setCookieSync(e,p)}),c){var f=o.toJSON().cookies;t.writeFileSync(c,JSON.stringify(f,null,2))}}return/^3/.test(""+s)&&(i={method:e,url:l.Location,options:n},s<=303&&(i.method="GET",delete i.options.data)),{response:{statusCode:s,data:u,headers:l},redirect:i}},b=function(e){return e.replace(/\?.*/,"")},O=function(e){return o.getCookiesSync(b(e)).join("; ")},P=function(e){var t=e.headers,o=e.data;if(/^2/.test(""+e.statusCode)){var n=""+t["Content-Type"];if(n.match("html"))return r.load(o);if(n.match("xml"))return r.load(o,{xmlMode:!0})}};return"get post put delete head patch".split(" ").forEach(function(e){h[e]=function(){try{var r=arguments;return Promise.resolve(v.apply(void 0,[e].concat([].slice.call(r))))}catch(e){return Promise.reject(e)}}}),h.submit=function(e,r,t){try{var o=h.$(e);return Promise.resolve(function(){if(o.length){var e=o.attr("action"),n=o.attr("method")||"GET";return r=Object.assign(o.serializeArray().reduce(function(e,r){return e[r.name]=r.value,e},{}),r||{}),Promise.resolve(v(n,e,a({},t,{data:r})))}}())}catch(e){return Promise.reject(e)}},h.text=function(){if(h.response)return h.response.data},h.json=function(){if(h.response.data&&h.response.headers["Content-Type"].toString().match("json"))return JSON.parse(h.response.data)},o=t.pathExistsSync(c)?i.fromJSON({cookies:t.readJsonSync(c)}):new i,h};
//# sourceMappingURL=webhead.js.map
